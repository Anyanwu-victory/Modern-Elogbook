"use client"

import React, { useState, useEffect } from "react"
import {
  BarChart3,
  BookOpen,
  Calendar,
  ChevronDown,
  ClipboardList,
  FileText,
  Home,
  LogOut,
  Menu,
  Settings,
  Users,
} from "lucide-react"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { ModeToggle } from "./mood-toggle"
import { Sheet, SheetContent, SheetTrigger } from "@/components/ui/sheet"
import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"

const mockUser = {
  firstName: "Demo",
  fullName: "Demo User",
  primaryEmailAddress: { emailAddress: "demo@example.com" },
}

interface DashboardLayoutProps {
  children: React.ReactNode
  userRole:
    | "student"
    | "industrySupervisor"
    | "instituteSupervisor"
    | "itfPersonnel"
    | "admin"
}

type TabValue =
  | "dashboard"
  | "submit-log"
  | "my-logs"
  | "profile"
  | "students"
  | "review-logs"
  | "calendar"
  | "users"
  | "analytics"
  | "settings"

const TABS = {
  student: [
    { value: "dashboard", name: "Dashboard", icon: Home },
    { value: "submit-log", name: "Submit Log", icon: FileText },
    { value: "my-logs", name: "My Logs", icon: ClipboardList },
    { value: "profile", name: "Profile", icon: Users },
  ],
  admin: [
    { value: "dashboard", name: "Dashboard", icon: Home },
    { value: "users", name: "Users", icon: Users },
    { value: "my-logs", name: "Logs", icon: BookOpen },
    { value: "analytics", name: "Analytics", icon: BarChart3 },
    { value: "settings", name: "Settings", icon: Settings },
  ],
  supervisor: [
    { value: "dashboard", name: "Dashboard", icon: Home },
    { value: "students", name: "Students", icon: Users },
    { value: "review-logs", name: "Review Logs", icon: ClipboardList },
    { value: "calendar", name: "Calendar", icon: Calendar },
  ],
}

const TAB_CONTENT: Record<TabValue, React.ReactNode> = {
  dashboard: <div>Dashboard Content</div>,
  "submit-log": <div>Submit Log Form</div>,
  "my-logs": <div>My Logs List</div>,
  profile: <div>Profile Settings</div>,
  students: <div>Students Management</div>,
  "review-logs": <div>Review Logs Interface</div>,
  calendar: <div>Calendar View</div>,
  users: <div>User Management</div>,
  analytics: <div>Analytics Dashboard</div>,
  settings: <div>System Settings</div>,
}

export function DashboardLayout({ children, userRole }: DashboardLayoutProps) {
  const [isMounted, setIsMounted] = useState(false)
  const [activeTab, setActiveTab] = useState<TabValue>("dashboard")

  const user = mockUser
  const isAdmin = userRole === "admin"
  const isStudent = userRole === "student"
  const tabs = isStudent ? TABS.student : isAdmin ? TABS.admin : TABS.supervisor

  useEffect(() => setIsMounted(true), [])
  if (!isMounted) return null

  const handleLogout = () => console.log("Logging out...")

  const renderSidebar = () => (
    <div className="hidden md:flex md:w-64 md:flex-col md:fixed md:inset-y-0 border-r">
      <div className="flex flex-col h-full">
        <div className="flex items-center justify-center h-16 px-4 border-b">
          <div className="flex items-center gap-2 font-semibold">
            <BookOpen className="h-6 w-6" /> E-Logbook
          </div>
        </div>
        <nav className="flex-1 px-2 py-4 space-y-1 overflow-y-auto">
          {tabs.map((tab) => (
            <Button
              key={tab.value}
              variant="ghost"
              className={cn(
                "w-full justify-start gap-3 px-3 py-2 text-sm font-medium rounded-md mx-2",
                activeTab === tab.value
                  ? "bg-primary text-primary-foreground"
                  : "text-muted-foreground hover:bg-muted hover:text-foreground"
              )}
              onClick={() => setActiveTab(tab.value as TabValue)}
            >
              <tab.icon className="h-5 w-5" /> {tab.name}
            </Button>
          ))}
        </nav>
        <div className="p-4 border-t">
          <div className="flex items-center gap-3">
            <div className="h-8 w-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center">
              {user.firstName.charAt(0)}
            </div>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium truncate">{user.fullName}</p>
              <p className="text-xs text-muted-foreground truncate">
                {user.primaryEmailAddress.emailAddress}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  )

  return (
    <div className="flex min-h-screen">
      {renderSidebar()}
      <div className="flex-1 md:ml-64">
        <header className="sticky top-0 z-40 w-full px-3 border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 lg:px-10">
          <div className="container flex h-14 items-center justify-between">
            <div className="flex items-center gap-2 md:hidden">
              <Sheet>
                <SheetTrigger asChild>
                  <Button variant="outline" size="icon">
                    <Menu className="h-5 w-5" />
                    <span className="sr-only">Toggle navigation menu</span>
                  </Button>
                </SheetTrigger>
                <SheetContent side="left" className="w-[240px] sm:w-[300px]">
                  <nav className="flex flex-col gap-4 py-4 h-full">
                    <div className="flex items-center justify-center h-16 px-4 border-b mb-4">
                      <div className="flex items-center gap-2 font-semibold">
                        <BookOpen className="h-6 w-6" /> E-Logbook
                      </div>
                    </div>
                    <div className="flex-1">
                      {tabs.map((tab) => (
                        <Button
                          key={tab.value}
                          variant="ghost"
                          className={cn(
                            "w-full justify-start gap-3 px-3 py-2 text-sm font-medium rounded-md mx-2",
                            activeTab === tab.value
                              ? "bg-primary text-primary-foreground"
                              : "text-muted-foreground hover:bg-muted hover:text-foreground"
                          )}
                          onClick={() => setActiveTab(tab.value as TabValue)}
                        >
                          <tab.icon className="h-5 w-5" /> {tab.name}
                        </Button>
                      ))}
                    </div>
                    <div className="p-4 border-t">
                      <div className="flex items-center gap-3">
                        <div className="h-8 w-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center">
                          {user.firstName.charAt(0)}
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="text-sm font-medium truncate">{user.fullName}</p>
                          <p className="text-xs text-muted-foreground truncate">
                            {user.primaryEmailAddress.emailAddress}
                          </p>
                        </div>
                      </div>
                      <Button
                        variant="ghost"
                        className="flex items-center gap-2 w-full mt-3 justify-start"
                        onClick={handleLogout}
                      >
                        <LogOut className="h-4 w-4" /> Logout
                      </Button>
                    </div>
                  </nav>
                </SheetContent>
              </Sheet>
            </div>

            <div className="md:hidden">
              <Tabs
                value={activeTab}
                onValueChange={(value) => setActiveTab(value as TabValue)}
                className="w-full"
              >
                <TabsList className="grid w-full grid-cols-2">
                  {tabs.slice(0, 2).map((tab) => (
                    <TabsTrigger key={tab.value} value={tab.value}>
                      {tab.name}
                    </TabsTrigger>
                  ))}
                </TabsList>
              </Tabs>
            </div>

            <div className="flex items-center gap-2">
              <ModeToggle />
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button variant="ghost" size="sm" className="gap-1">
                    <div className="h-8 w-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center">
                      {user.firstName.charAt(0)}
                    </div>
                    <ChevronDown className="h-4 w-4" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  <DropdownMenuItem onClick={() => setActiveTab("profile")}> <Users className="mr-2 h-4 w-4" /> Profile </DropdownMenuItem>
                  <DropdownMenuItem onClick={handleLogout}> <LogOut className="mr-2 h-4 w-4" /> Logout </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
          </div>
        </header>

        <main className="flex-1 container py-6">{TAB_CONTENT[activeTab]}</main>

        <footer className="w-full border-t py-4">
          <div className="container flex flex-col items-center justify-between gap-4 md:flex-row">
            <p className="text-xs text-muted-foreground">
              © {new Date().getFullYear()} E-Logbook System. All rights reserved.
            </p>
          </div>
        </footer>
      </div>
    </div>
  )
}











































































"use client"

import type React from "react"
import { useState, useEffect } from "react"
import Link from "next/link"
import { usePathname, useRouter } from "next/navigation"
import {
  BarChart3,
  BookOpen,
  Calendar,
  ChevronDown,
  ClipboardList,
  FileText,
  Home,
  LogOut,
  Menu,
  Settings,
  Users,
} from "lucide-react"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { ModeToggle } from "./mood-toggle"
import { Sheet, SheetContent, SheetTrigger } from "@/components/ui/sheet"
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu"

// Mock user data
const mockUser = {
  firstName: "Demo",
  fullName: "Demo User",
  primaryEmailAddress: { emailAddress: "demo@example.com" },
}

interface DashboardLayoutProps {
  children: React.ReactNode
  userRole: "student" | "industrySupervisor" | "instituteSupervisor" | "itfPersonnel" | "admin"
}

export function DashboardLayout({ children, userRole }: DashboardLayoutProps) {
  const router = useRouter()
  const pathname = usePathname()
  const [isMounted, setIsMounted] = useState(false)
  const [isMobileNavOpen, setIsMobileNavOpen] = useState(false)

  // Mock user data
  const user = mockUser
  const isSignedIn = true

  useEffect(() => {
    setIsMounted(true)
  }, [])

  if (!isMounted) {
    return null
  }

  const studentNavItems = [
    { name: "Dashboard", href: "/dashboard", icon: Home },
    { name: "Submit Log", href: "/dashboard/submit-logs", icon: FileText },
    { name: "My Logs", href: "/dashboard/my-logs", icon: ClipboardList },
    { name: "Profile", href: "/dashboard/profile", icon: Users },
  ]

  const industrySupervisorNavItems = [
    { name: "Dashboard", href: "/supervisor", icon: Home },
    { name: "Students", href: "/supervisor/students", icon: Users },
    { name: "Review Logs", href: "/supervisor/review-logs", icon: ClipboardList },
    { name: "Calendar", href: "/supervisor/calendar", icon: Calendar },
  ]

  const instituteSupervisorNavItems = [
    { name: "Dashboard", href: "/supervisor", icon: Home },
    { name: "Students", href: "/supervisor/students", icon: Users },
    { name: "Review Logs", href: "/supervisor/review-logs", icon: ClipboardList },
    { name: "Calendar", href: "/supervisor/calendar", icon: Calendar },
  ]

  const itfPersonnelNavItems = [
    { name: "Dashboard", href: "/supervisor", icon: Home },
    { name: "Students", href: "/supervisor/students", icon: Users },
    { name: "Review Logs", href: "/supervisor/review-logs", icon: ClipboardList },
    { name: "Calendar", href: "/supervisor/calendar", icon: Calendar },
  ]

  const adminNavItems = [
    { name: "Dashboard", href: "/admin", icon: Home },
    { name: "Users", href: "/admin/users", icon: Users },
    { name: "Logs", href: "/admin/logs", icon: BookOpen },
    { name: "Analytics", href: "/admin/analytics", icon: BarChart3 },
    { name: "Settings", href: "/admin/settings", icon: Settings },
  ]

  const navItems =
    userRole === "student" ? studentNavItems : 
    userRole === "industrySupervisor" ? industrySupervisorNavItems : 
    userRole === "instituteSupervisor" ? instituteSupervisorNavItems : 
    userRole === "itfPersonnel" ? itfPersonnelNavItems : 
    adminNavItems

  const handleLogout = () => {
    router.push("/")
  }

  return (
    <div className="flex min-h-screen">
      {/* Desktop Sidebar */}
      <div className="hidden md:flex md:w-64 md:flex-col md:fixed md:inset-y-0 border-r">
        <div className="flex flex-col h-full">
          {/* Sidebar header */}
          <div className="flex items-center justify-center h-16 px-4 border-b">
            <Link href={userRole === "student" ? "/dashboard" : "/admin"} className="flex items-center gap-2 font-semibold">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className="h-6 w-6"
              >
                <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
              </svg>
              E-Logbook
            </Link>
          </div>
          
          {/* Sidebar navigation */}
          <nav className="flex-1 px-2 py-4 space-y-1 overflow-y-auto">
            {navItems.map((item, index) => (
              <Link
                key={index}
                href={item.href}
                className={cn(
                  "flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md mx-2",
                  pathname === item.href 
                    ? "bg-primary text-primary-foreground" 
                    : "text-muted-foreground hover:bg-muted hover:text-foreground"
                )}
              >
                <item.icon className="h-5 w-5" />
                {item.name}
              </Link>
            ))}
          </nav>
          
          {/* Sidebar footer */}
          <div className="p-4 border-t">
            <div className="flex items-center gap-3">
              <div className="h-8 w-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center">
                {user.firstName.charAt(0)}
              </div>
              <div className="flex-1 min-w-0">
                <p className="text-sm font-medium truncate">{user.fullName}</p>
                <p className="text-xs text-muted-foreground truncate">{user.primaryEmailAddress.emailAddress}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Main content area */}
      <div className="flex-1 md:ml-64">
        {/* Top header */}
        <header className="sticky top-0 z-40 w-full px-3 border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 lg:px-10">
          <div className="container flex h-14 items-center justify-between">
            <div className="flex items-center gap-2 md:hidden">
              <Sheet>
                <SheetTrigger asChild>
                  <Button variant="outline" size="icon">
                    <Menu className="h-5 w-5" />
                    <span className="sr-only">Toggle navigation menu</span>
                  </Button>
                </SheetTrigger>
                <SheetContent side="left" className="w-[240px] sm:w-[300px]">
                  <nav className="flex flex-col gap-4 py-4 h-full">
                    <div className="flex items-center justify-center h-16 px-4 border-b mb-4">
                      <Link 
                        href={userRole === "student" ? "/dashboard" : "/admin"} 
                        className="flex items-center gap-2 font-semibold"
                        onClick={() => setIsMobileNavOpen(false)}
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          strokeWidth="2"
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          className="h-6 w-6"
                        >
                          <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
                        </svg>
                        E-Logbook
                      </Link>
                    </div>
                    
                    <div className="flex-1">
                      {navItems.map((item, index) => (
                        <Link
                          key={index}
                          href={item.href}
                          onClick={() => setIsMobileNavOpen(false)}
                          className={cn(
                            "flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md mx-2",
                            pathname === item.href 
                              ? "bg-primary text-primary-foreground" 
                              : "text-muted-foreground hover:bg-muted hover:text-foreground"
                          )}
                        >
                          <item.icon className="h-5 w-5" />
                          {item.name}
                        </Link>
                      ))}
                    </div>
                    
                    <div className="p-4 border-t">
                      <div className="flex items-center gap-3">
                        <div className="h-8 w-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center">
                          {user.firstName.charAt(0)}
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="text-sm font-medium truncate">{user.fullName}</p>
                          <p className="text-xs text-muted-foreground truncate">{user.primaryEmailAddress.emailAddress}</p>
                        </div>
                      </div>
                      <Button
                        variant="ghost"
                        className="flex items-center gap-2 w-full mt-3 justify-start"
                        onClick={() => {
                          handleLogout()
                          setIsMobileNavOpen(false)
                        }}
                      >
                        <LogOut className="h-4 w-4" />
                        Logout
                      </Button>
                    </div>
                  </nav>
                </SheetContent>
              </Sheet>
              <Link href={userRole === "student" ? "/dashboard" : "/admin"} className="flex items-center gap-2 font-semibold md:hidden">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  className="h-6 w-6"
                >
                  <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" />
                </svg>
                <span className="sr-only">E-Logbook</span>
              </Link>
            </div>
            
            <div className="flex items-center gap-2">
              <ModeToggle />
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button variant="ghost" size="sm" className="gap-1">
                    <div className="h-8 w-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center">
                      {user.firstName.charAt(0)}
                    </div>
                    <ChevronDown className="h-4 w-4" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  <DropdownMenuItem onClick={() => router.push("/user-profile")}>
                    <Users className="mr-2 h-4 w-4" />
                    <span>Profile</span>
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={handleLogout}>
                    <LogOut className="mr-2 h-4 w-4" />
                    <span>Logout</span>
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
          </div>
        </header>

        {/* Main content */}
        <main className="flex-1 container py-6">{children}</main>
        
        {/* Footer */}
        <footer className="w-full border-t py-4">
          <div className="container flex flex-col items-center justify-between gap-4 md:flex-row">
            <p className="text-xs text-muted-foreground">
              © {new Date().getFullYear()} E-Logbook System. All rights reserved.
            </p>
          </div>
        </footer>
      </div>
    </div>
  )
}

























































 
const onSubmit = async (data: FormData) => {
  setIsSubmitting(true);

  try {
    const existingUser = await client.fetch(
      `*[_type == "user" && clerkId == $clerkId][0]`,
      { clerkId: user?.id }
    );

    if (existingUser) {
      toast({
        title: "Account already set up",
        description: "You’ve already completed your setup.",
        variant: "destructive",
      });
      router.push(getDashboardPath(existingUser.role));
      return;
    }

    let signatureAsset;
    if (data.signature?.length > 0) {
      signatureAsset = await client.assets.upload("image", data.signature[0], {});
    }

    const userDoc = {
      _type: "user",
      clerkId: user?.id,
      phoneNumber: data.phoneNumber,
      role: data.role,

      ...(data.role === "student" && {
        faculty: data.faculty,
        department: data.department,
        course: data.course,
        level: data.level,
        matricNo: data.matricNo,
        organizationName: data.organizationName,
        organizationAddress: data.organizationAddress,
        supervisorName: data.supervisorName,
        supervisorEmail: data.supervisorEmail,
        startDate: data.startDate,
        endDate: data.endDate,
      }),
      ...(data.role === "industry_supervisor" && {
        staffId: data.staffId,
        organizationName: data.organizationName,
        department: data.department,
        section: data.section,
        signature: signatureAsset ? {
          _type: "image",
          asset: { _ref: signatureAsset._id }
        } : undefined,
      }),
      ...(data.role === "institution_supervisor" && {
        staffId: data.staffId,
        position: data.position,
        faculty: data.faculty,
        department: data.department,
        signature: signatureAsset ? {
          _type: "image",
          asset: { _ref: signatureAsset._id }
        } : undefined,
      }),
      ...(data.role === "itf" && {
        staffId: data.staffId,
        officeLocation: data.officeLocation,
      }),
      ...(data.role === "admin" && {
        staffId: data.staffId,
        faculty: data.faculty,
        signature: signatureAsset ? {
          _type: "image",
          asset: { _ref: signatureAsset._id }
        } : undefined,
      }),
    };

    await client.create(userDoc);

    toast({
      title: "Account setup complete",
      description: "Redirecting to your dashboard...",
    });

    onOpenChange(false);
    router.push(getDashboardPath(data.role));

  } catch (error) {
    console.error("Error setting up account:", error);
    toast({
      title: "Error",
      description: "There was an error setting up your account. Please try again.",
      variant: "destructive",
    });
  } finally {
    setIsSubmitting(false);
  }
};

//   const onSubmit = async (data: FormData) => {
//     setIsSubmitting(true)

// try {
  

//     let signatureAsset;
//     if (data.signature && data.signature.length > 0) {
//       signatureAsset = await client.assets.upload("image", data.signature[0], {});
//     }

//     const userDoc = {
//       _type: "user",
//       clerkId: user?.id,
//       // email: user?.emailAddresses[0]?.emailAddress,
//       // firstName: user?.firstName,
//       // lastName: user?.lastName,
//       // PhoneNumber: data.phoneNumber,
//       // role: data.role,

//       //student fields
//       ...(data.role === "student" && {
//         faculty: data.faculty,
//         department: data.department,
//         course: data.course,
//         level: data.level,
//         matricNo: data.matricNo,
//         organizationName: data.organizationName,
//         organizationAddress: data.organizationAddress,
//         supervisorName: data.supervisorName,
//         supervisorEmail: data.supervisorEmail,
//         startDate: data.startDate,
//         endDate: data.endDate,
//       }),
//       //industry supervisor fields
//       ...(data.role === "industry_supervisor" && {
//         staffId: data.staffId,
//         organizationName: data.organizationName,
//         department: data.department,
//         section: data.section,
//         phoneNumber: data.phoneNumber,
//         signature: signatureAsset ? 
//           { _type: "image", asset: { _ref: signatureAsset._id } } : undefined,
//       }),
//       //institution supervisor fields
//       ...(data.role === "institution_supervisor" && {
//         staffId: data.staffId,
//         position: data.position,
//         faculty: data.faculty,
//         department: data.department,
//         phoneNumber: data.phoneNumber,
//         signature: signatureAsset ? 
//         { _type: "image", asset: { _ref: signatureAsset._id } } : undefined,
//       }),
//       //ITF fields
//       ...(data.role === "itf" && {
//         staffId: data.staffId,
//         officeLocation: data.officeLocation,
//         phoneNumber: data.phoneNumber,
//       }),
//       //admin fields
//       ...(data.role === "admin" && {
//         staffId: data.staffId,
//         faculty: data.faculty,
//         phoneNumber: data.phoneNumber,
//         signature: signatureAsset ? 
//         { _type: "image", asset: { _ref: signatureAsset._id } } : undefined,
//       }),
//     }

//     //Check if user already exists in Sanity 
//     const existingUser = await client.fetch(
//       `*[_type == "user" && clerkId == $clerkId][0]`,
//       { clerkId: user?.id }
//     )
   
//     if (existingUser) {
//       await client
//           .patch(existingUser._id)
//           .set(userDoc)
//           .commit()
//     } else {
//       await client.create(userDoc)
//     }
//     toast({
//       title: "Account setup complete",
//       description: "Your account has been successfully set up.",
//     })
//     onOpenChange(false)
//     onComplete()
//   } catch (error) {
//     console.error("Error setting up account:", error)
//     toast({
//       title: "Error",
//       description: "There was an error setting up your account. Please try again.",
//       variant: "destructive",
//     })
//   } finally {
//     setIsSubmitting(false)
//   }
//     // In a real application, you would send this data to your backend
//     console.log("Form submitted:", data)


//   }








































































// app/api/setup-profile/route.ts

import { NextResponse } from 'next/server';
import { getClient } from "@/sanity/lib/sanity.client" // Adjust the path to your sanity client
import { revalidatePath } from 'next/cache'; // Optional
import { z } from 'zod';
import {writeToken} from "@/sanity/lib/sanity.api"; // Adjust the path to your sanity API


const profileSchema = z.object({
  userId: z.string(),
  role: z.enum(["student", "industry_supervisor", "institution_supervisor", "itf", "admin"]),
  signature: z.string().optional(), // Base64 or file name
  data: z.record(z.any())
});

export async function POST(req: Request) {
     const client = getClient({ token: writeToken });

  try {
    const body = await req.json();
    const parsed = profileSchema.parse(body);

    const { userId, role, data, signature } = parsed;
    
    console.log("submitting with clerk ID:",userId);

    const existingUser = await client.fetch(
      `*[_type == "user" && clerkId == $clerkId][0]`,
      { clerkId: userId }
    );

    
    if (!existingUser) {
      return NextResponse.json({ error: "User not found." }, { status: 404 });
    }

    let signatureAsset;
    if (signature) {
      const buffer = Buffer.from(signature.split(',')[1], 'base64');
      signatureAsset = await client.assets.upload('image', buffer, {
        filename: 'signature.png',
        contentType: 'image/png',
      });
    }

    const patchFields: any = {
      ...(role === "student" && {
        faculty: data.faculty,
        department: data.department,
        course: data.course,
        level: data.level,
        matricNo: data.matricNo,
        organizationName: data.organizationName,
        organizationAddress: data.organizationAddress,
        supervisorName: data.supervisorName,
        supervisorEmail: data.supervisorEmail,
        startDate: data.startDate,
        endDate: data.endDate,
      }),
      ...(role === "industry_supervisor" && {
        staffId: data.staffId,
        organizationName: data.organizationName,
        department: data.department,
        section: data.section,
        phoneNumber: data.phoneNumber,
        signature: signatureAsset ? {
          _type: "image",
          asset: { _ref: signatureAsset._id }
        } : undefined,
      }),
      ...(role === "institution_supervisor" && {
        staffId: data.staffId,
        position: data.position,
        faculty: data.faculty,
        department: data.department,
        phoneNumber: data.phoneNumber,
        signature: signatureAsset ? {
          _type: "image",
          asset: { _ref: signatureAsset._id }
        } : undefined,
      }),
      ...(role === "itf" && {
        staffId: data.staffId,
        officeLocation: data.officeLocation,
        phoneNumber: data.phoneNumber,
      }),
      ...(role === "admin" && {
        staffId: data.staffId,
        faculty: data.faculty,
        phoneNumber: data.phoneNumber,
        signature: signatureAsset ? {
          _type: "image",
          asset: { _ref: signatureAsset._id }
        } : undefined,
      }),
    };

    await client
      .patch(existingUser._id)
      .set(patchFields)
      .commit();

    return NextResponse.json({ success: true }, { status: 200 });
  } catch (error: any) {
    console.error("API Error:", error);
    return NextResponse.json({ error: error.message || "Server error" }, { status: 500 });
  }
}
